package gr.uoa.di.storemanagement.web;

import gr.uoa.di.storemanagement.datalayer.entities.role.Role;
import gr.uoa.di.storemanagement.datalayer.entities.role.dao.RoleDaoImpl;
import gr.uoa.di.storemanagement.datalayer.entities.user.UserForApproval;
import gr.uoa.di.storemanagement.datalayer.entities.user.dao.UserDaoImpl;
import gr.uoa.di.storemanagement.datalayer.entities.user.dao.UserForApprovalDaoImpl;

import java.io.IOException;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

public class Signup extends HttpServlet {

	private static final long serialVersionUID = 1L;
	private UserForApproval user;
	private String url;
	private String username;
	private String password;
	private String rpassword;
	private String firstname;
	private String lastname;
	private String roleName;
	private String email;
	private Pattern p;
	private Matcher m;
	private boolean matchFound;
	private UserDaoImpl userDao;
	private UserForApprovalDaoImpl userForApprovalDao;
	private ServletContext context;
	private RequestDispatcher dispatcher;
	private RoleDaoImpl roleDao;
	private Role role;

	protected void doGet(HttpServletRequest request,
			HttpServletResponse response) throws ServletException, IOException {

		username = request.getParameter("username");
		if (username == null) username = "";

		password = request.getParameter("password");
		if (password == null) password = "";

		rpassword = request.getParameter("rpassword");
		if (rpassword == null) rpassword = "";

		firstname = request.getParameter("firstname");
		if (firstname == null) firstname = "";

		lastname = request.getParameter("lastname");
		if (lastname == null) lastname = "";

		email = request.getParameter("email");
		if (email == null) email = "";
		
		roleName = request.getParameter("role");
		if (roleName == null) roleName = "";


			if (!username.equals("") && !password.equals("") && !firstname.equals("") && !lastname.equals("") && !email.equals("") && !roleName.equals("")) {

				if (password.equals(rpassword)) {

					p = Pattern.compile(".+@.+\\.[a-z]+");
					m = p.matcher(email);
					matchFound = m.matches();
					if (!matchFound) {
						request.setAttribute("error", "invalid email address");

						request.setAttribute("username", username);
						request.setAttribute("firstname", firstname);
						request.setAttribute("lastname", lastname);
						request.setAttribute("email", "");
						request.setAttribute("role", role);
						url = "/signup.jsp";
					} else {
						userDao = new UserDaoImpl();
						userForApprovalDao = new UserForApprovalDaoImpl();
						user = new UserForApproval();
						roleDao = new RoleDaoImpl();
						
						role = roleDao.read(roleName);

						user.setUsername(username);
						user.setPassword(password);
						user.setFirstName(firstname);
						user.setLastName(lastname);
						user.setEmail(email);
						user.setRole(role);

						if (!userForApprovalDao.userExists(user.getUsername()) && !userDao.userExists(user.getUsername())) {
							userForApprovalDao.create(user);
							url = "/thankyou.html";
						} else {
							request.setAttribute("error", "username exists");

							request.setAttribute("username", "");
							request.setAttribute("firstname", firstname);
							request.setAttribute("lastname", lastname);
							request.setAttribute("email", email);
						request.setAttribute("role", role);
							url = "/signup.jsp";
						}
					}
				} else {
					request.setAttribute("error",
							"trying to signup with different passwords");

					request.setAttribute("username", username);
					request.setAttribute("firstname", firstname);
					request.setAttribute("lastname", lastname);
					request.setAttribute("email", email);
						request.setAttribute("role", role);
					url = "/signup.jsp";
				}
			} else {
				request.setAttribute("error", "null value");

				request.setAttribute("username", username);
				request.setAttribute("password", password);
				request.setAttribute("firstname", firstname);
				request.setAttribute("lastname", lastname);
				request.setAttribute("email", email);
						request.setAttribute("role", role);
				url = "/signup.jsp";
			}

		context = getServletContext();
		dispatcher = context.getRequestDispatcher(url);
		dispatcher.forward(request, response);
	}

	protected void doPost(HttpServletRequest request,
			HttpServletResponse response) throws ServletException, IOException {
		doGet(request, response);
	}

}
